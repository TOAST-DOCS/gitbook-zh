## Network > Load Balancer > 控制台使用指南

## 创建负载管理

### 创建负载均衡
只需在控制台输入必要参数，即可轻松创建负载均衡（load balancer）。

#### 负载均衡信息
输入负载均衡相关基本信息。所需内容如下。

* 名称: 输入负载均衡名称。
* 说明: 输入负载均衡相关说明。
* Network (Subnet): 指定负载均衡将要连接的 VPC 子网。
* Loadbalancer Type : 有标准型和专用型两种可供选择。

[注意] 有关负载均衡类型的详细信息，请参考[负载均衡类型](/service/network/load_balancer)。


#### 添加监听
对负载均衡将要处理的流量属性进行定义。在NHN Cloud的负载均衡中，默认存在一个监听端口，此后，在负载均衡的详细信息页面，可进行创建或删除监听端口。

* 负载均衡调度算法: 设置负载均衡处理连接请求的算法。选择ROUND_ROBIN, LEAST_CONNECTIONS, SOURCE_IP 中的一个。
* 协议: 指定用来接收请求并向后端服务器进行请求转发的负载均衡系统的前端协议。选择 TCP, HTTP, HTTPS, TERMINATED_HTTPS 中的一个。
* 负载均衡端口: 指定用来接收请求并向后端服务器进行请求转发的负载均衡系统的端口。
* 实例端口（instance port）: ECS实例上开放的用来接收请求的后端端口。通过负载均衡端口流入的流量（traffic）将被转发到ECS开放的后端端口。

> [参考] 负载均衡端口与实例端口，可指定从 1到 65535 之间的值。

> [注意] 创建监听之后，无法更改负载均衡端口、实例端口及协议。

* SSL 证书: 协议选择 TERMINATED_HTTPS 时，需要注册所要使用的证书。仅在协议选择 TERMINATED_HTTPS 的时，才可被激活。

> [参考] TERMINATED_HTTPS证书注册方法
>
> 若将负载均衡的监听器协议指定为TERMINATED_HTTPS，注册SSL证书的按钮将被激活。
>
> 要注册的文件为“证书”与“私钥”“私钥”指与服务器证书内置的公钥成对的私钥。
>
> “证书”采用如下所示的x.509 PEM格式。
>
>     -----BEGIN CERTIFICATE-----
>     （内容省略）
>     -----END CERTIFICATE-----
>
>
> 需同时注册服务器证书与链证书(Chain Certificate, Intermediate Certificate)时，应将服务器证书和链证书
 创建为一个文件后注册。
>
> 创建为一个证书文件时，应在文件最上端描述服务器证书，在其下端描述链证书。链证书可按与顺序>无关描述。
>
>若将1个服务器证书和2个链证书创建为一个证书文件，格式如下。
>
>
>      -----BEGIN CERTIFICATE-----
>      （服务器证书内容省略）
>      -----END CERTIFICATE-----
>      -----BEGIN CERTIFICATE-----
>      （链证书#1内容省略）
>      -----END CERTIFICATE-----
>      -----BEGIN CERTIFICATE-----
>      （链证书#2内容省略）
>      -----END CERTIFICATE-----
>
>
>
> “私钥”为与包含在服务器证书中的公钥对应的密钥文件。
>
> 可注册PKCS#1或PKCS#8 PEM格式的文件。
>
>
>
>      -----BEGIN RSA PRIVATE KEY-----
>      （私钥内容省略）
>      -----END RSA PRIVATE KEY-----
>
>或
>
>      -----BEGIN PRIVATE KEY-----
>      （私钥内容省略）
>      -----END PRIVATE KEY-----

##### Certificate Manager 사용
리스너에서 TERMINATED_HTTPS 프로토콜을 사용하는 경우 인증서 등록 방법은, Certificate Manager에 등록한 인증서를 사용하는 방법과 직접 등록하는 방법 두 가지입니다.

* Certificate Manager 서비스에 인증서를 등록하고 리스너에 해당 인증서를 연결하면 이메일로 인증서 만료일 알람을 받을 수 있습니다.
* 리스너에 직접 인증서를 등록한 경우에는 인증서 만료일 알람이 없습니다. 다만 콘솔의 리스너 화면에서 만료일을 확인할 수는 있습니다.
> [주의 사항]
> Certificate Manager 서비스에서 인증서를 갱신한 경우, 영향을 받는 리스너의 인증서도 같이 갱신해야 합니다.
> Certificate Manager에 등록한 인증서를 리스너에 사용하려면 '개인 키'의 비밀번호가 반드시 제거돼야 하고, PKCS#1 또는 PKCS#8 PEM 형식이어야 합니다.

##### 确认状态

健康检查(health check)的相关设置，也在创建监听时进行。 NHN Cloud的负载均衡，根据监听协议选择健康检查方式。所需项如下：

* 健康检查方式: 选择健康检查使用的协议。选择 TCP, HTTP, HTTPS 中的一个。
* 检查端口: ECS实例上开放的用来接收请求的端口。
* HTTP请求方法: 选择健康检查时所要使用的 HTTP请求方法。需要健康检查方式选择为HTTP或 HTTPS。现只支持 GET。
* HTTP 状态码: 输入健康检查正常的HTTP状态码。需要健康检查方式选择为HTTP或 HTTPS。现只支持 GET。
* URL: 输入健康检查对象的URL路径对。需要健康检查方式选择为HTTP或 HTTPS
* 健康检查间隔: 输入健康检查间隔。单位为 “秒”。进行健康检查的时间间隔
* 响应超时时间: 每次健康检查响应的最大超时时间。单位为“秒”，如果超过已指定的超时时间则视为失败。
* 不健康阀值: 表示云服务器从成功到失败的连续健康检查失败次数。

##### 连接
连接相关设置 :

* 会话保持:确保一系列相关联的访问请求分配到同一台服务器上。 选择No Session Persistence, APP_COOKIE, HTTP_COOKIE, SOURCE_IP 中的一个。
* 连接限制: 指定基本监听同时维持的TCP连接数。 标准型负载均衡最大可以设置的连接数为60,000，专用型负载均衡最大可以设置的连接数为480,000。
* Keepalive Timeout : 指定客户端及服务器的会话保持时长，以秒为单位。只要对方维持会话，负载均衡就会维持这段时间的会话。建议此处设置与服务器上相同的keepalive timeout值。默认设置为300秒。
* Proxy Protocol : 负载均衡可以支持代理协议。当服务器启用代理协议以获取客户端的IP时，则需启用此值，仅在使用TCP及HTTPS协议时可用。

#### 添加服务器
负载均衡创建时添加后端服务器。后端服务器也可在负载均衡创建以后进行。只有属于负载均衡所连接 VPC的服务器，才能添加到负载均衡。

#### IP访问控制组
指定创建负载均衡时应用的IP访问控制组。可以在IP访问控制组中选择具有相同访问控制类型的多个组。创建负载均衡后，也可以更改应用的IP访问控制组。

### 负载均衡详细说明
负载均衡的创建完成后，将重新回到负载均衡列表。在负载均衡列表，可确认已创建的负载均衡基本信息。可在列表中进行确认的项目如下。

* 名称: 负载均衡创建时填写的负载均衡名称。
* 类型：负载均衡类型。
* IP地址: 是从连接至负载均衡的 VPC分配获得的IP。在VPC内部，可通过该 IP访问负载均衡。而在 VPC 外部，若需要访问负载均衡则需要绑定浮动IP。
* 负载均衡端口/实例端口:负载均衡的监听端口和后端实例端口。
* 协议: 是属于负载均衡的监听协议。
* IP访问控制类型：显示为负载均衡指定的IP控制组的类型。若不指定访问控制组，什么都不显示，若指定，具有“允许”及“断开”中的一个类型。
* 网络: 是指连接至负载均衡的 VPC名称及子网 CIDR。
* 状态：显示负载均衡创建状态。若标记为ACTIVE，则为正常创建。

> [参考] 负载均衡的创建状态为以下其中之一。

> | 状态 | 描述 |
> |--|--|
> | ACTIVE | 负载均衡创建完成，正常运行中 |
> | PENDING_CREATE | 正在创建负载均衡<br>若创建后一个小时内未更改为ACTIVE状态，请咨询管理员。|
> | PENDING_UPDATE | 正在更改负载均衡设置<br>若更改设置后一个小时内未更改为ACTIVE状态，请咨询管理员。|
> | PENDING_DELETE | 正在删除负载均衡<br>若删除后一个小时内未从列表中消失，请咨询管理员。|
> | ERROR | 创建负载均衡失败<br>请咨询管理员。|
> | ERROR_MIGRATE | 遷移负载均衡失败<br>请咨询管理员。|

### 负载均衡更改及详细信息

负载均衡列表中，选择所期望的负载均衡，则将呈现出已选择负载均衡的详细信息。详细信息分为三个部分。对各部分的说明如下：

* 负载均衡详细信息: 显示当前负载均衡的详细信息。可更改已选择的监听名称及描述。
* 监听: 可对当前负载均衡所创建的监听进行确认。同时，可以添加新的监听，或者删除现有监听。
* 服务器: 可查看所选择的负载均衡上添加的服务器列表。可添加新的后端服务器，或者删除现有服务器。
* 统计：可以查看所选负载均衡的统计信息。

> [参考] 无法更改负载均衡所连接的 VPC及IP 地址。

#### 添加监听
负载均衡的详细信息，选择 **监听** 标签之后，可以通过点击**添加监听** 按钮来添加监听。添加监听所需内容与负载均衡创建时主监听所需内容相同。添加监听时，无法使用现有监听所使用的负载均衡端口。

#### 更改监听
点击要修改的监听 **更改** 按钮，则可对监听的设置进行更改。

> [参考] 无法更改监听的协议、负载均衡端口以及实例端口（instance port）。

#### 删除监听
点击要删除的监听 **删除** 按钮，相关监听将会被删除。但，在已选择的负载均衡上只有一个监听时，将无法进行删除。

> [注意] 若添加，更改或删除监听，负载均衡将会重启。因负载均衡会瞬间停止，并且可能发生无法预测的障碍、故障。因此，监听更改作业应选择对服务不产生影响的时间来进行。

#### 添加服务器
在**服务器** 标签中，可将新的服务器添加到负载均衡中。只有属于负载均衡所连接 VPC的服务器，才能添加到负载均衡。

#### 停用服务器
在服务器列表中，需要临时从负载均衡排外服务器时，可进行停用。在需要排外的服务器中，选择使用项目的 `True`,则被更改为 `False`并被停用。

#### 删除服务器
可删除不再使用的服务器。点击要删除的服务器**服务器删除** 按钮，则将从已选择的负载均衡删除。不会因为从负载均衡中删除了服务器而服务器也被删除。

> [注意] 若添加，更改或删除监听，负载均衡将会重启。因负载均衡会瞬间停止，并且可能发生无法预测的障碍、故障。因此，监听更改作业应选择对服务不产生影响的时间来进行。

### 删除负载均衡
负载均衡的列表中，选择要删除的负载均衡，再点击**删除** 按钮，相关负载均衡将被删除。

## IP访问控制组
IP访问控制组功能的相关详细事项参考[IP访问控制](/Network/Load%20Balancer/zh/overview/#ip)文件。

#### 创建IP访问控制组
若欲创建IP访问控制组，按[创建访问控制组]按钮，输入下列值。

* 名称：输入访问控制组的名称。
* 说明：记述访问控制组的说明。
* IP访问控制类型：在断开与允许中选择。
* 添加IP访问控制对象：记述作为访问控制对象的IP与说明。按右侧“+”按钮，可以一次性添加多个访问控制对象。若欲更加方便地实现大量输入，可以选择[大量输入]。此种情况下，在一行中输入“IP地址或CIDR”与“说明”。可以一次性输入最多100个访问控制对象。


按[确认]，创建访问控制组和对象。

> [参考] IP访问控制组与IP访问控制对象的个数
>
> 各项目最多可创建10个访问控制组。
> 各项目最多可创建1,000个访问控制对象。

#### 更改IP访问控制组
可以更改IP访问控制组的属性。可更改的属性为名称与说明。“IP访问控制类型”属性无法更改。

#### 删除IP访问控制组
可以删除选择的IP访问控制组。若删除组，组中的所有访问控制对象也将删除。
若删除IP访问控制组，使用该组的负载均衡将无法继续使用该策略。

#### 添加IP访问控制对象
若选择访问控制组，下端显示访问控制对象菜单。
若在访问控制组中添加对象，添加的IP或CIDR的策略将反映到使用该访问控制组的所有负载均衡中。

#### 更改IP访问控制对象
可以更改访问控制对象的属性。仅可更改说明。

#### 删除IP访问控制对象
若选择访问控制组，下端显示访问控制对象菜单。
若删除访问控制组中的对象，使用该访问控制组的所有负载均衡中的相应IP或CIDR的策略将被删除。

#### 应用IP访问控制组
选择要应用IP访问控制组的负载均衡。在相应的负载均衡中选择要设置的组并按确认。
可在负载均衡中应用多个“访问控制类型”相同的组。

## 用于维护设备的负载均衡重启指南

NHN Cloud定期升级负载均衡设备软件，提供基本基础设施服务的安全性及稳定性。为维护负载均衡，在维护对象设备中驱动的负载均衡应通过重启移动至完成维护的负载均衡设备。

需要重启的负载均衡在名称旁显示**! 显示重启**按钮，可以使用该按钮重启。

移动至被指定为维护对象的负载均衡所在的项目，下一步骤进行重启。

1. 确认维护对象负载均衡。名称旁有**! 有重启**按钮的负载均衡是维护对象负载均衡。
   ![image-001](http://static.toastoven.net/prod_load_balancer/lb_p_migration_zh_1.png)
   **! 把鼠标光标移至重启**按钮上时，可确认详细的维护日程。请在不影响服务的时间执行。
   ![image-002](http://static.toastoven.net/prod_load_balancer/lb_p_migration_zh_2.png)
2. 选择维护对象负载均衡，单击名称旁的**! 单击重启**按钮。
3. 当询问是否重启负载均衡的窗口弹出时，单击**确定**按钮。
   ![image-003](http://static.toastoven.net/prod_load_balancer/lb_p_migration_zh_3.png)
4. 状态显示灯变为绿色，等待至**! 重启**按钮消失。
   若负载均衡状态显示灯未改变或**! 重启**按钮未消失，请进行“刷新”。
   ![image-004](http://static.toastoven.net/prod_load_balancer/lb_p_migration_zh_4.png)

负载均衡重启过程中，无法对相应负载均衡进行任何操作。
若负载均衡重启未正常完成，将自动向管理员报告，NHN Cloud会另行联系您。

